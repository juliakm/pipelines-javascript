trigger: 
- master

pool: server

# jobs:
# - job: 'firststage_job1'
#   steps:
  # - task: AzureFunction@1
  #   displayName: FunctionTry $(System.StageAttempt)
  #   inputs:
  #     function: 'https://myfunctionappgh.azurewebsites.net/api/httptriggercsharp1'
  #     key: '$(myFunctionKey)'
  #     method: 'POST'
  #     queryParameters: 'name=$(myVar)$(System.StageAttempt)'
  #     waitForCompletion: 'false'
  # - stage: 'second'
  #   dependsOn:
  #     - first
  #   condition: eq(variables['Checks.JobAttempt'], '1')
jobs:
  - deployment: FunctionTwo
    timeoutInMinutes: 7200
    displayName: job1
    environment:
      name: ContosoDeploy
      resourceType: VirtualMachine
    strategy:
      runOnce:
        deploy:
          steps:
            - task: AzureFunction@1
              displayName: FunctionTry $(Checks.StageAttempt)
              inputs:
                function: 'https://myfunctionappgh.azurewebsites.net/api/httptriggercsharp1'
                key: '$(myFunctionKey)'
                method: 'POST'
                queryParameters: 'name=$(myVar)$(Checks.StageAttempt)'
                waitForCompletion: 'false'
              continueOnError: true
            - task: InvokeRESTAPI@1
              inputs:
                connectionType: 'connectedServiceName'
                serviceConnection: 'github zen'
                method: 'POST'
                urlSuffix: '/$(checks.stageattempt)'
                waitForCompletion: 'true'


    # jobs:
    # - job: 'secondstage_job1'
    #   steps:
    #   - task: AzureFunction@1
    #     inputs:
    #       function: 'https://myfunctionappgh.azurewebsites.net/api/httptriggercsharp1'
    #       key: '$(myFunctionKey)'
    #       method: 'POST'
    #       queryParameters: 'name=$(checks.stageattempt)'
    #       waitForCompletion: 'false'
# - script: |
#           echo "attempt is changing with number of attempts"
#           echo "current attempt is $(system.stageattempt)"
#           echo "current checks is $(checks.stageattempt)"
#           exit 1


# stages:
#   - stage: 'first'
#     jobs:
#     - job: 'firststage_job1'
#       steps:
#       - script: |
#               echo "attempt is changing with number of attempts"
#               echo "current attempt is $(system.stageattempt)"
#               echo "current checks is $(checks.stageattempt)"
#               exit 1
#         displayName: 'ischanging-$(system.stageattempt)'     
#         continueOnError: true
#   - stage: 'second'
#     dependsOn: 
#     - first
#     jobs:
#     - deployment: DeployWeb1
#       timeoutInMinutes: 7200
#       displayName: job1
#       environment: 
#         name: ContosoDeploy
#         resourceType: VirtualMachine
#       strategy:
#         runOnce:
#           deploy:
#             steps:
#             - script: |
#                 echo "attempt is changing with number of attempts"
#                 echo "current attempt is $(system.stageattempt)"
#                 echo "current checks attempt is $(checks.stageattempt)"
#                 exit 1
#               displayName: "notchanging-$(system.stageattempt)"
#               continueOnError: true

